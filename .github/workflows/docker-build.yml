name: Docker Build and Push

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯æˆ–åˆ›å»ºtag
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# ç¯å¢ƒå˜é‡
env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: liubowyf0452
  IMAGE_NAME: liubowyf0452/magic-telegram-server

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. è®¾ç½®Javaç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. ç¼“å­˜Mavenä¾èµ–
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    # 4. é…ç½®Mavenè®¾ç½®ï¼ˆæ·»åŠ TDLightä»“åº“ï¼‰
    - name: Setup Maven settings
      uses: s4u/maven-settings-action@v3.1.0
      with:
        repositories: |
          [
            {
              "id": "central",
              "name": "Maven Central Repository",
              "url": "https://repo1.maven.org/maven2",
              "snapshots": {"enabled": false}
            },
            {
              "id": "tdlight",
              "name": "TDLight Repository",
              "url": "https://mvn.mchv.eu/repository/mchv/",
              "snapshots": {"enabled": true}
            },
            {
              "id": "spring-releases",
              "name": "Spring Releases",
              "url": "https://repo.spring.io/release",
              "snapshots": {"enabled": false}
            }
          ]
        pluginRepositories: |
          [
            {
              "id": "central",
              "name": "Maven Plugin Repository",
              "url": "https://repo1.maven.org/maven2",
              "snapshots": {"enabled": false}
            }
          ]
        
    # 5. Mavenæ„å»ºå’Œæµ‹è¯•ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    - name: Build with Maven
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 3
        command: |
          echo "å¼€å§‹Mavenæ„å»º..."
          mvn clean compile -DskipTests -U
          echo "Mavenç¼–è¯‘å®Œæˆ"
        
    - name: Run tests
      run: |
        echo "å¼€å§‹è¿è¡Œæµ‹è¯•..."
        mvn test -Dmaven.test.failure.ignore=true
        echo "æµ‹è¯•å®Œæˆ"
        
    - name: Package application
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 15
        max_attempts: 3
        command: |
          echo "å¼€å§‹æ‰“åŒ…åº”ç”¨..."
          mvn package -DskipTests -U
          echo "åº”ç”¨æ‰“åŒ…å®Œæˆ"
          ls -la target/
          
    # 6. éªŒè¯æ„å»ºäº§ç‰©
    - name: Verify build artifacts
      run: |
        if [ ! -f target/*.jar ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ°JARæ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æ„å»ºæˆåŠŸï¼šæ‰¾åˆ°JARæ–‡ä»¶"
        ls -la target/*.jar
        
    # 7. è®¾ç½®Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # 8. ç™»å½•Docker Hub
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 9. æå–ç‰ˆæœ¬ä¿¡æ¯å’Œæ ‡ç­¾ç­–ç•¥
    - name: Extract version and tags
      id: version
      run: |
        echo "æå–ç‰ˆæœ¬ä¿¡æ¯..."
        
        # åŸºç¡€é•œåƒåç§°
        IMAGE_BASE="${{ env.IMAGE_NAME }}"
        
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          # Tagæ¨é€ï¼šä½¿ç”¨tagç‰ˆæœ¬å·
          VERSION=${GITHUB_REF#refs/tags/}
          IS_LATEST="true"
          TAGS="${IMAGE_BASE}:${VERSION},${IMAGE_BASE}:latest"
          echo "ğŸ“¦ Tagæ„å»º: $VERSION (æ ‡è®°ä¸ºlatest)"
        elif [[ $GITHUB_REF == refs/heads/main ]]; then
          # Mainåˆ†æ”¯æ¨é€ï¼šä½¿ç”¨commit hash
          VERSION="main-${GITHUB_SHA::8}"
          IS_LATEST="false"
          TAGS="${IMAGE_BASE}:${VERSION},${IMAGE_BASE}:main"
          echo "ğŸ”„ Mainåˆ†æ”¯æ„å»º: $VERSION"
        else
          # å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨åˆ†æ”¯åå’Œcommit hash
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          VERSION="${BRANCH_NAME}-${GITHUB_SHA::8}"
          IS_LATEST="false"
          TAGS="${IMAGE_BASE}:${VERSION}"
          echo "ğŸŒ¿ åˆ†æ”¯æ„å»º: $VERSION"
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "IS_LATEST=$IS_LATEST" >> $GITHUB_OUTPUT
        echo "TAGS=$TAGS" >> $GITHUB_OUTPUT
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "VCS_REF=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        
        echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $TAGS"
        
    # 10. æ„å»ºDockeré•œåƒï¼ˆå¤šæ¶æ„ï¼‰
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.version.outputs.TAGS }}
        build-args: |
          BUILD_DATE=${{ steps.version.outputs.BUILD_DATE }}
          VCS_REF=${{ steps.version.outputs.VCS_REF }}
          VERSION=${{ steps.version.outputs.VERSION }}
        cache-from: |
          type=gha,scope=buildkit-${{ matrix.platform || 'multi' }}
          type=registry,ref=${{ env.IMAGE_NAME }}:cache
        cache-to: |
          type=gha,mode=max,scope=buildkit-${{ matrix.platform || 'multi' }}
        provenance: false
        sbom: false
        
    # 11. éªŒè¯é•œåƒæ¨é€
    - name: Verify image push
      if: github.event_name != 'pull_request'
      run: |
        echo "ğŸ” éªŒè¯é•œåƒæ¨é€ç»“æœ..."
        
        # è§£ææ ‡ç­¾
        IFS=',' read -ra TAG_ARRAY <<< "${{ steps.version.outputs.TAGS }}"
        
        for TAG in "${TAG_ARRAY[@]}"; do
          echo "éªŒè¯æ ‡ç­¾: $TAG"
          
          # æ‹‰å–é•œåƒéªŒè¯
          if docker pull "$TAG"; then
            echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ: $TAG"
            
            # æ£€æŸ¥é•œåƒå¤§å°
            SIZE=$(docker image inspect "$TAG" --format='{{.Size}}')
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "ğŸ“ é•œåƒå¤§å°: ${SIZE_MB}MB"
            
            if [ $SIZE_MB -gt 500 ]; then
              echo "âš ï¸  è­¦å‘Š: é•œåƒå¤§å°è¶…è¿‡500MB"
            else
              echo "âœ… é•œåƒå¤§å°ç¬¦åˆè¦æ±‚"
            fi
            
            # æ£€æŸ¥é•œåƒæ¶æ„
            echo "ğŸ—ï¸  é•œåƒæ¶æ„ä¿¡æ¯:"
            docker buildx imagetools inspect "$TAG" --format '{{json .}}' | jq -r '.manifests[]? | select(.platform != null) | "å¹³å°: " + .platform.os + "/" + .platform.architecture'
            
          else
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥: $TAG"
            exit 1
          fi
        done
        
        echo "ğŸ‰ æ‰€æœ‰é•œåƒéªŒè¯é€šè¿‡ï¼"
        
    # 12. æ„å»ºæ‘˜è¦
    - name: Build summary
      if: always()
      run: |
        echo "## æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ steps.version.outputs.VCS_REF }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒ**: ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **çŠ¶æ€**: âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **çŠ¶æ€**: âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
    # 13. é€šçŸ¥æ„å»ºç»“æœ
    - name: Notify build result
      if: failure()
      run: |
        echo "âŒ æ„å»ºå¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "å¸¸è§é—®é¢˜æ’æŸ¥ï¼š"
        echo "1. Mavenä¾èµ–ä¸‹è½½å¤±è´¥ - æ£€æŸ¥ç½‘ç»œè¿æ¥"
        echo "2. å•å…ƒæµ‹è¯•å¤±è´¥ - æ£€æŸ¥æµ‹è¯•ä»£ç "
        echo "3. Dockeræ„å»ºå¤±è´¥ - æ£€æŸ¥Dockerfileè¯­æ³•"
        echo "4. æ¨é€å¤±è´¥ - æ£€æŸ¥Docker Hubå‡­æ®"